<%- include('../partials/header', { title: 'Detall Incidència #' + incident.id }) %>

    <div class="title-box">
        <h1>INCIDÈNCIA #<%= incident.id %>: <%= incident.title %></h1>
    </div>

    <div class="incident-details" style="width: 80%; max-width: 900px; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid #ddd; margin-bottom: 30px;">
        <h2>Detalls</h2>
        <p><strong>Descripció:</strong><br><%= incident.description.replace(/\n/g, '<br>') %></p>
        <hr>
        <p><strong>Reportat per:</strong> <%= incident.reporter ? incident.reporter.username : 'N/A' %> (<%= incident.createdAt.toLocaleString('ca-ES') %>)</p>
        <p><strong>Assignat a:</strong> <%= incident.assignedUser ? incident.assignedUser.username : 'No assignat' %></p>
        <p><strong>Estat:</strong> <%= incident.Status ? incident.Status.name : 'N/A' %></p>
        <p><strong>Prioritat:</strong> <%= incident.Priority ? incident.Priority.name : 'N/A' %></p>
        <% if (incident.resolutionDate) { %>
            <p><strong>Data Resolució:</strong> <%= incident.resolutionDate.toLocaleString('ca-ES') %></p>
        <% } %>
        <p><strong>Última actualització:</strong> <%= incident.updatedAt.toLocaleString('ca-ES') %></p>
         <div style="margin-top: 20px;">
             <a href="/incidents/<%= incident.id %>/edit" class="action-buttons" style="background-color: #ffc107; color: black; padding: 8px 15px;">Editar Incidència</a>
             <a href="/incidents" class="action-buttons" style="background-color: #6c757d; color: white; padding: 8px 15px; margin-left: 10px;">Tornar a la Llista</a>
         </div>
    </div>

    <div class="incident-comments" style="width: 80%; max-width: 900px; background-color: #f8f9fa; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid #ddd;">
        <h2>Comentaris</h2>
        <% if (incident.Comments && incident.Comments.length > 0) { %>
            <ul style="list-style: none; padding: 0;">
                <% incident.Comments.forEach(comment => { %>
                    <li style="border-bottom: 1px dashed #ccc; padding-bottom: 15px; margin-bottom: 15px;">
                        <p><%= comment.text.replace(/\n/g, '<br>') %></p>
                        <small>Per: <strong><%= comment.User ? comment.User.username : 'N/A' %></strong> el <%= comment.createdAt.toLocaleString('ca-ES') %></small>
                    </li>
                <% }); %>
            </ul>
        <% } else { %>
            <p>No hi ha comentaris per a aquesta incidència.</p>
        <% } %>

        <hr style="margin-top: 25px; margin-bottom: 25px;">

        <h3>Afegir Nou Comentari</h3>
        <!-- Formulari per afegir comentari -->
        <form action="/incidents/<%= incident.id %>/comments" method="POST" class="incident-form">
            <div class="form-group">
                <label for="comment_text">Text del Comentari:</label>
                <textarea id="comment_text" name="text" rows="4" required></textarea>
            </div>
            <!-- IMPORTANT: Necessites l'ID de l'usuari que fa el comentari -->
            <!-- En un sistema real, aquest valor vindria de la sessió de l'usuari logat -->
            <!-- Per ara, farem un selector (temporal per proves) -->
             <div class="form-group">
                <label for="comment_user">Usuari:</label>
                <select id="comment_user" name="userId" required>
                    <option value="" disabled selected>-- Selecciona usuari --</option>
                     <%# Hauries de passar la llista d'usuaris a aquesta vista també, o obtenir l'usuari logat %>
                     <%# Temporalment pots copiar el bucle d'usuaris del form 'new' si els passes %>
                     <option value="1">admin (Temporal)</option> <%# Canvia '1' per un ID real d'usuari de la teva BD per provar %>
                     <option value="2">jtec (Temporal)</option> <%# Canvia '2' per un ID real d'usuari de la teva BD per provar %>
                </select>
            </div>
            <div class="form-group">
                <button type="submit">Afegir Comentari</button>
            </div>
        </form>
    </div>

<%- include('../partials/footer') %>