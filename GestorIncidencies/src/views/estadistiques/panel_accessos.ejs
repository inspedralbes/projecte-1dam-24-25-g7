<%- include('../partials/header', { title: title }) %>

    <div class="title-box">
        <h1><%= title %></h1>
    </div>

    <!-- Formulari de Filtres -->
    <div style="max-width: 1000px; margin: 20px auto; padding: 20px; background-color: #f9f9f9; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <form method="GET" action="/estadistiques/accessos">
            <h3 style="margin-bottom: 15px;">Filtrar Estadístiques</h3>
            <div style="display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap;">
                <div class="form-group">
                    <label for="dataInici">Data Inici:</label>
                    <input type="date" id="dataInici" name="dataInici" value="<%= queryParams.dataInici || '' %>" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div class="form-group">
                    <label for="dataFi">Data Fi:</label>
                    <input type="date" id="dataFi" name="dataFi" value="<%= queryParams.dataFi || '' %>" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div class="form-group">
                    <label for="rutaFilter">Ruta (conté):</label>
                    <input type="text" id="rutaFilter" name="rutaFilter" value="<%= queryParams.rutaFilter || '' %>" placeholder="Ex: /incidencies" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div class="form-group">
                    <button type="submit" class="action-buttons" style="padding: 8px 15px;">Aplicar Filtres</button>
                    <a href="/estadistiques/accessos" class="action-buttons" style="padding: 8px 15px; background-color: #6c757d; color:white; margin-left:10px;">Netejar Filtres</a>
                </div>
            </div>
        </form>
    </div>

    <div class="main-content" style="align-items: flex-start; max-width: 1000px; margin: auto; display: flex; flex-direction: column; gap: 30px;">

        <!-- Resum Total d'Accessos -->
        <div class="stats-section" style="width: 100%; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h2>Resum General</h2>
            <p><strong>Nombre total d'accessos registrats (segons filtre):</strong> <%= totalAccessos %></p>
        </div>

        <!-- Gràfic de Pàgines Més Visitades (Incrustat des d'Atlas Charts) -->
        <div class="stats-section" style="width: 100%; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h2>Pàgines Més Visitades</h2>
            <iframe style="background: #FFFFFF;border: none;border-radius: 2px;box-shadow: 0 2px 10px 0 rgba(70, 76, 79, .2); width: 100%; min-height: 480px;" src="https://charts.mongodb.com/charts-project-0-hnrbwzl/embed/charts?id=e0387f2c-27b5-432b-8a77-a5fa258248c3&maxDataAge=3600&theme=light&autoRefresh=true"></iframe>
        </div>

        <!-- Gràfic d'Accessos Diaris (Incrustat des d'Atlas Charts) -->
        <div class="stats-section" style="width: 100%; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h2>Accessos Diaris</h2>
            <iframe style="background: #FFFFFF;border: none;border-radius: 2px;box-shadow: 0 2px 10px 0 rgba(70, 76, 79, .2); width: 100%; min-height: 480px;" src="https://charts.mongodb.com/charts-project-0-hnrbwzl/embed/charts?id=c2fbcbd2-8b16-4788-8b6d-e90b350d09a4&maxDataAge=3600&theme=light&autoRefresh=true"></iframe>
        </div>
        
        <!-- Taula de Pàgines Més Visitades (generada amb dades del backend) -->
        <div class="stats-section" style="width: 100%; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h2>Top 10 Pàgines Més Visitades (Taula segons filtre)</h2>
            <% if (paginesMesVisitades && paginesMesVisitades.length > 0) { %>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr style="background-color: #eee;">
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Ruta (Pàgina)</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: right;">Nombre de Visites</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% paginesMesVisitades.forEach(pagina => { %>
                            <tr>
                                <td style="border: 1px solid #ccc; padding: 8px;"><%= pagina._id %></td>
                                <td style="border: 1px solid #ccc; padding: 8px; text-align: right;"><%= pagina.comptador %></td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            <% } else { %>
                <p>No hi ha dades de pàgines visitades per mostrar amb els filtres actuals.</p>
            <% } %>
        </div>

        <!-- Taula d'Últims Accessos Registrats (generada amb dades del backend) -->
        <div class="stats-section" style="width: 100%; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h2>Últims 50 Accessos Registrats (segons filtre)</h2>
            <% if (ultimsAccessos && ultimsAccessos.length > 0) { %>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr style="background-color: #eee;">
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Timestamp</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Ruta Visitada</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% ultimsAccessos.forEach(acces => { %>
                            <tr>
                                <td style="border: 1px solid #ccc; padding: 8px;"><%= new Date(acces.timestamp).toLocaleString('ca-ES') %></td>
                                <td style="border: 1px solid #ccc; padding: 8px;"><%= acces.ruta %></td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            <% } else { %>
                <p>No hi ha accessos registrats per mostrar amb els filtres actuals.</p>
            <% } %>
        </div>

         <div class="action-buttons" style="margin-top: 20px;">
            <a href="/">Tornar a l'Inici</a>
        </div>
    </div>

<%- include('../partials/footer') %>